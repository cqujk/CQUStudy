# 4 .1 网络层的几个概念
电信网：通信时先建立连接，在分组交换时是建立一条虚电路

传统互联网的每个路由器，既有转发表又有路由选择软件
SDN 中，其中的路由选择软件都不存在了，路由器之间不再相互交换路由信息，网络控制层面有一个远程控制器
# 4 .2 网际协议 IP
协议 IP 配套使用三个协议：
- 地址解析协议 ARP
- 网际控制报文协议 ICMP
- 网际组管理协议 IGMP

不同网络互连起来需要一些中间设备。根据所在层次不同，有四种
- 物理层叫转发器
- 数据链路层为网桥或桥接器，以及交换机
- 网络层为路由器，有时也叫网关
- 网络层以上的为网关
	- 连接两个不兼容系统时需要在高层进行协议的转换
用转发器或网桥，仅仅是吧一个网络扩大了，还是一个网络

协议 IP 使性能各异的网络在网络层上看起来是一个统一的网络

应先查找自己的转发表，看 H 2 是否在本网络上，若在则不通过路由器；不然，则需发送给路由器，路由器查转发表，若在和路由器相同的一个网络上，则结束，不然则继续转发。
IP 地址是给连接到互联网上的每一台主机（或路由器）的一个接口，分配一个在全世界范围内唯一的 32位标识符
IP 地址现由互联网名字和数字分配机构 ICANN 进行分配

IP 采用两级结构，第一个字段是网络号，标志主机或路由器所连接到的网络
	网络号在整个互联网范围内必须是唯一的
第二个字段是主机号，用来标志该主机，一个主机号在所连接的网络中必须是唯一的
表明的是连接到某个网络上的一个主机
前 n 位是主机所连网络号，后 32-n位是主机号
A 类，n=8；B 类，n=16; C 类，n=24

![[Pasted image 20240918105436.png]] A 类地址中：
- 对于网络号：
	- 网络号全为 0 的 IP 地址表示本网络；
	- 为 127，即 01111111 保留作为本地软件进行环回测试，本主机的进程之间的通信用
	- A 类网络号固定为 0，则可指派的网络号是 126 个，即 $2^7 -2$
- 对于主机号
	- 全 0 表示该 IP 是本主机所连接的单个网络地址，即就是网络号
	- 全 1 表示该网络上的所有主机
	- 每个 A 类网络中的最大主机数是 $2^{24}-2$
![[Pasted image 20240918110207.png]]

#### CIDR
发现 IP 地址在不久后会枯竭，一种新的无分类编址方法 CIDR
无分类域间路由选择 CIDR
把网络号改称为网络前缀
IP 地址后面加上斜线，斜线后面是网络前缀所占位数

CIDR 就是把原来只能是 A, BCD 类的地址类型扩展开了，可以通过地址掩码来随意指定网络号的长度，从而扩大了 IP 地址的可用范围
*CIDR 的出现，使同一个 IP 地址，如果子网掩码不一样，那么也是不一样的 IP地址；即此时是由子网掩码与 IP 地址共同确定的*
因为如果子网掩码不同，那么运算完后的网络号是不一样的，网络号都不一样，那么自然是不一样的地址
**地址掩码**
由于计算机看不见斜线记法，因此使用 32位地址掩码，从 IP 地址迅速计算出网络地址；
一串 1 和一串 0 组成，1 的长度 n就是网络前缀的长度
也即子网掩码

N=32 时，32 位地址都是前缀，没有主机号，这个特殊地址用于主机路由
#### IP 地址特点
当一台主机同时连接到两个网络上时，就必须同时具有两个相应的 IP 地址
IP 地址是标志一个主机连接在网络上的接口
![[Pasted image 20240918111741.png]]
同一个局域网上的主机或路由器的 IP 地址的网络前缀必须相同
	此时看前缀，就必须要结合子网掩码来看
网络地址里的主机号必定是全 0
以太网交换机是链路层设备，只有 MAC地址
用以太网交换机连接的几个网段合起来仍是一个局域网，使用同样的网路前缀
*路由器总是具有两个或两个以上的 IP 地址，即路由器每个接口的 IP 地址的网络前缀都不同*
/31 地址块，专门为*点对点链路*的两端使用，主机号是 0 或 1，
对于点对点链路构成的特殊网络，现在也常常不分配 IP 地址，这种特殊网络叫做无编号网络或匿名网络

### IP 地址与 MAC地址
物理地址、硬件地址和 MAC 地址是同义词
其反义词是虚拟地址、软件地址或逻辑地址，IP 地址属于此类

MAC 地址是数据链路层使用的地址，IP 是网络层和以上各层使用的地址
*使用 IP 地址的 IP 数据报一旦交给数据链路层，就被封装成 MAC帧*
只有在剥去 MAC 帧的首部和尾部后，把 MAC 层的数据上交给网络层后，网络层才能在 IP 数据报的首部中找到源 IP 地址和目的 IP 地址
![[Pasted image 20240918113651.png]]
*路由器 $R_1$ 因同时连接到两个局域网上，因此有两个 MAC地址, 同时路由器也有多个 IP地址*
网络层源地址和目的地址，IP 地址始终没变，
而在数据链路层的源地址与目标地址，MAC地址一直在改变 ^6b177f

MAC 帧在不同网络上传送时，其 MAC 帧首部中的源地址和目的地址要发生变化

### 地址解析协议 ARP
主机或路由器怎样知道应带在 MAC 帧的首部填入什么样的 MAC 地址？

在一个网络上（这个网络可能指的就是一个局域网）可能经常会有新的主机加入进来或撤走一些主机。
更换网络适配器也会使主机的 MAC 地址改变，*主机的 MAC 地址实际上就是其网络适配器的 MAC地址*
每台主机都设有一个 ARP 高速缓存，里面存有本局域网上的各主机和路由器的 IP 地址到 MAC 地址的映射表
A 向 B 发送 IP 数据报时，先在 ARP 中查有无 B 的 IP 地址，若有就写入，然后通过局域网把 MAC 帧发往此 MAC地址[[CQUStudy/OtherStudy 1/未命名#^ff8e3f]]
若没有，可能是 B 刚入网，或 A 刚刚加电，高速缓存还是空的
找出 MAC地址
	1. ARP 进程在本局域网上广播发送一个 ARP请求分组，即“我的 IP 地址是 xx, MAC 地址是 xx, 请求 IP 地址为 xx 的主机的 MAC地址”
	2. 本局域网上的所有主机上运行的 ARP进程都收到此 ARP 请求分组
	3. B 的 IP 地址与 ARP 请求分组中的一致，收下，并向 A 发送 ARP 响应分组，在其中写入自己的 MAC 地址
	4. A 收到 B 的 ARP 后，在 ARP 高速缓存中写入
若不用 ARP 高速缓存，则任何一台主机只要进行一次通信，都要在网络上进行广播，发送 ARP 请求分组

ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和 MAC 地址映射问题
若不在，则将位于同一局域网上的路由器的 IP 地址 $IP_3$ 解析为 MAC 地址 $MAC_3$ 作为目的 MAC [[Class/Net/Note/InitialLearning/Book/BookNote/网络层/第四章#^6b177f]]，路由器从转发表知道应把数据报转发到下一个路由器上，使用 ARP 解析出 $R_2$ 的 MAC 地址 $MAC_5$, 完成下一跳
![[Pasted image 20240918120451.png]]

各式各样的网络使用不同的 MAC 地址，要使这些异构网络能够互相通信，必须进行非常复杂的 MAC地址转化工作
IP 地址到 MAC 地址的解析是自动进行的，所谓解析，并不是通过 IP 到 MAC 的映射，计算得到，而只是如上面所说的方式一样，通过广播来获取，所以此时也就无所谓 MAC 地址的各种形式了，只要负责记录就行了
### IP 数据报格式
下面的每一种数据链路层协议都规定了一个数据帧中的数据字段的最大长度，最大传送单元 MTU
	IP 数据报的总长度一定不能超过下面规定的 MTU
	若超过，则需要分片
	
IP 首部：长度是固定的
- 版本占 4 位，IPv 4 或 6，通信双方的协议 IP版本必须一致
- 首部长度，占 4位
- 区分服务，占 8 位，用来获得更好的服务
- 总长度，指首部和数据之和的长度，16位
- 标识，16 位。IP 软件在存储器中维持一个计数器，每产生一个数据报就+1，这个标识是数据报的标识，因为数据报可能进行分组，所以可以用来判别分组后的各报文是否同属于同一个数据报
- 标志，占 3 位，但目前只有 2 位有意义，
	- 最低位记为 MF，为 1时表示后面还有分片，若为 0，则表示已是最后一个
	- 中间一位为 DF，不能分片，只有 DF=0 时才允许分片
- 片偏移，13 位，表示较长的分组在分片后，某片在原分组中的相对位置
	- 以 8 个字节为偏移单位，除了最后一个以外，其他每个分片的长度一定是 8字节
- TTL，表示在路由器之间的跳转次数，每经过一次路由器就要减 1
![[Pasted image 20240918134449.png]]
# IP层转发分组的过程
## 基于终点的转发
待转发的分组怎样能够*找到*下一跳路由器
路由器收到一个待转发的分组后，从转发表得出下一跳路由器的 IP 地址，送交数据链路层的网络接口软件，其负责把下一跳路由器的 IP 地址使用 ARP转换成 MAC 地址，利用这个 MAC 地址传送到下一跳路由器的链路层
查转发表、调用 ARP 解析出 MAC 地址、把 MAC 地址写入 MAC 帧的首部

主机先把要发送的分组的目的地址和本网络的子网掩码进行与运算，得到运算结果，如果等于本网络的前缀，就表明目的主机在本网络上，否则必须发送到路由器上
![[Pasted image 20240918144339.png]]
CIDR 的出现，让点十标记法不再那么明显，因为前缀长度不再固定是以每个点为分割的了，也就是说即使某一段的点间数据相同，也不一定同属于一个网络；或者即使不同，也可能同属于一个网络
标记每段网络的地址，用 IP 地址与子网掩码共同确定；其中 IP 地址只有网络号有值，主机号均为 0；
*在查找路由表的时候，就是让**目的地址和不同网的子网掩码进行与运算**，然后与其对应的网络号进行判断，若相同则匹配上了，否则就下一个*
## 最长前缀匹配
在采用 CIDR 编址时，如果一个分组在转发表中可以找到多个匹配的前缀，那么应当选择前缀最长的一个作为匹配的前缀
前缀越长，地址块越小，因而路由就越具体

主机路由，特定主机路由，对特定目的主机的 IP 地址专门指明的一个路由，对应于主机路由的网络前缀是 a.b.c.d/32
	*主机路由在转发表中都放在最前面*
默认路由，不管分组的最终目的网络在哪里，都由指定的路由器 R 来处理，特殊前缀 0.0.0.0/0
	*由于前缀长度为 0，所以一般在转发表的最后*

**分组转发算法（转发表按照前缀的长短排列，把前缀长的放在前面）如下：**
- 从收到的分组首部提取主机的 IP地址
- 若查找到有特定主机路由，就按照这条路由的下一跳转发分组；
	- 否则从转发表中下一行开始检查
- 把这一行的子网掩码与目的地址按位与运算
	- 若运算结果与*本行的前缀*匹配，则查找结束，按照下一跳所指出的进行处理（直接交付本网络上的目的主机，或通过指定接口发送到下一跳路由器）
		- 路由器就是联通上了两个局域网，处于两个或多个局域网当中，因此就是有多个 IP 地址，即网络号
		- 查找路由表，就是在查找网络号，若是能找到网络号，自然就能找到对应网络上的主机
- 若转发表有一个默认路由，则按照指明的接口，把分组传送到指明的默认路由器，否则报告转发分组出错

## 使用二叉线索查找转发表
使用 CIDR，不知道目的网络的前缀
最简单的方式是对所有可能的前缀进行循环查找，从最长的前缀开始查找，最坏情况要进行 32次

*树的深度取决于前缀，即网络号的长度*，二叉搜索的根节点自顶向下的深度最多有 32 层，每一层对应于 IP 地址中的一位
就是将路由表当中所有的项目数组织成一个树，自顶层向下为每项的位，若匹配则向对应的方向上走，每个结点都分出 0 和 1两条路（若对应项存在的话）
当搜索到叶结点时，必须将寻找匹配的目的地址和该叶结点的子网掩码进行与运算

# ICMP
## 种类
ICMP 差错报告报文和 ICMP询问报文
前 4 字节是统一格式，类型、代码和校验和
![[Pasted image 20240918155826.png]]
ICMP差错报告报文
- 终点不可达：路由器或主机不能交付数据报，向源点发送
- 时间超过：收到 TTL 为 0 的数据报时
- 参数问题：首部中有的字段值不正确
- 重定向：找到了更好的路由

主机发送数据报时，首先查找自己的转发表
## 应用举例

分组网间探测 PING，用来测试两台主机之间的连通性

Tracert，跟踪一个分组从源点到终点的路径
	从源主机向目的主机发送一连串的 IP 数据报，封装的是无法交付的 UDP 用户数据报，$P_1$ 的生存时间 TTL 设置为 1，这样路由器就会回发一个 *ICMP时间超过的差错报告报文*
	接着就是不断地逐次延长 TTL，直到到达目的主机，但由于是无法交付的 UDP，所以目的主机也要发送 *ICMP终点不可达的差错报告报文*
	最终组合成一个完整的路径
# IPV 6
## 基本首部
支持即插即用，即自动配置，不需要使用 DHCP
首部改为 8 字节对齐，即首部长度必须是 8 字节的整数倍，原来的 IPV 4 首部是 4 字节对齐
IPV 6 取消了首部长度字段，它的首部长度是固定的
## 地址
冒号十六进制记法
允许把数字前面的 0 省略，允许零压缩
未指明地址就是主机还没有配置到一个标准的 IP 地址，这类地址仅此一个
## 从 IPV 4 向 IPV 6过度
**双协议栈**
安装上两套协议
**隧道技术**
IPV 6 进入 IPV 4 网络时，把其封装成 IPV 4数据报
整个 IPV 6 变为 IPV 4的数据部分
必须把 IPV 4 首部的协议字段值设置为 41
## ICMPV 6
# 互联网的路由选择协议
把互联网划分为许多较小的自治系统，AS
把路由选择协议划分为两大类，即
- 内部网关协议 IGP
	- 有 RIP 和 OSPF等
- 外部网关协议 EGP
	- 源主机和目的主机在不同的自治系统中，
	- BGP-4
自治系统之间的路由选择叫做域间路由选择，内部的是域内
## 内部网关协议 RIP
基于距离向量
要求路由器维护自己到其它目的网络的距离记录, 就是跳数
最大允许距离为 15，大于 15 时认为为不可达，只适用小型互联网
他选择具有最少网络数的路由，即使这条路延时比较高
所有路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址
每个 RIP 报文，有三个关键数据，为目标网络 NET，距离 d，下一跳路由器
	到达一个路由器后，对其进行修改，


# IP多播
与单播相比，要传递给 30 个，就需要发送 30次
而多播只需要 1 次，即一个源点发送到多个终点的情形
多播数据不产生 ICMP 差错报文，若在 PING 命令后键入多播地址，则永远不会收到响应
## 网际组管理协议 IGMP 和多播路由选择协议
参与多播组，就会有一个组地址
路由器通过网际组管理协议 IGMP 来知道多播组的成员信息
他并不知道所包含的成员数，也不知道这些成员都分布在哪些网络上，他是让连接在本地局域网上的多播路由器知道本局域网上是否有主机，即主机上的某个进程是否参与或推出了某个多播组
多播路由器还必须和其它多播路由器协同工作，多播路由选择协议
单播路由选择通常在网络拓朴发生变化时才需要更新路由

网际控制报文协议 ICMP
网际组管理协议 IGMP
# 虚拟专用网 VPN 和网络地址转换 NAT
## 虚拟专用网 VPN
很多情况下，很多主机主要是和本机构其他的主机进行
仅在本机构有效的 IP 地址，即本地地址
向互联网的管理机构申请全球唯一的 IP 地址，为全球地址
机构内部某台主机和互联网连接，可能出现 IP 地址重合，造成二义性
路由器对目的地址是专用地址的一律不转发
专用 IP 地址，全球可能有很多专用互连网络具有相同的 IP 地址，因为仅在本机构使用，即可重用地址
*采用专用 IP 地址的互联网是专用网*
要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并配置，使每一个场所的 VPN系统都知道其它场所的地址
如果要通过公用的互联网，则必须进行数据加密
和公用互联网的接口地址必须是合法的全球 IP 地址，在专用网内部的接口地址是专用网的本地地址
## 网络地址转换 NAT
装有 NAT 软件的路由器是 NAT 路由器，至少有一个有效的外部全球 IP地址
两个不同专用网内部的主机交流时，不知道起内部的专用地址，只是知道其连接的 NAT 转换的全球 IP地址
	NAT 有 n 个全球 IP 地址，则最多可以同时有 n台主机接入
使用端口号的 NAT 叫做网络地址与端口号转换 NAPT
# 多协议标签交换MPLS
用硬件对打上标签的 IP 数据报进行转发叫标签交换
标签交换路由器 LSR 使用标签分配协议 LDP 交换报文，*找出和特定标签相对应的路由*，即标签交换路径 LSP
LSR 根据路径构造出转发表
面向连接的，因为 LSP 上的第一个 LSR 就根据 IP 数据报的初始标签确定了整个交换路径，就像一条虚连接
# SDN
把网络的控制层面和数据层面分离，让控制层面利用软件来控制数据层面的许多设备
OpenFlow 是 SDN 中控制与数据之间的接口
传统转发两个步骤，
- 第一个是匹配：查找转发表中的网络前缀，进行最长前缀匹配
- 第二个是动作：把分组从指明的接口转发出去
SDN 转发
- 匹配能对不同层次（链路、网络、运输）的首部字段进行匹配
- 动作还可以把具有同样目的地址的分组从不同的接口转发出去
	- 重写 IP 首部，如同 NAT
	- 人为阻拦一些分组，防火墙


使用通配符*, 表示来自前 16 位 10.3的任何地址，如果去往 10.2 的任何地址，都将进行指定的动作

# 小结
*用转发器或网桥连接起来的若干局域网仍为一个网络*
所有分配到网络前缀的网络都是平等的

路由聚合就是把许多前缀相同的地址用一个来代替，正如用通配符一样，有利于减少路由表中的项目